<html>
    <head>
        <meta charset=utf-8 />
        <title>San Diego Bike Map</title>
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

        <!-- Load Leaflet from CDN-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
        integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
        integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
        crossorigin=""></script>

        <!-- Load Esri Leaflet from CDN -->
        <script src="https://unpkg.com/esri-leaflet@^3.0.8/dist/esri-leaflet.js"></script>
        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">

        <style>
            body { margin: 0; padding: 0; }
            #map { position: absolute; top: 0; bottom: 0; right: 0; left: 0; }
            .leaflet-control-layers-selector { vertical-align: top; }
            .dot {
                height: 0.8em;
                width: 0.8em;
                border-radius: 50%;
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div id="map">
        </div>
        <div id="legend-elements" style="display: hidden;">
            <div id='overlay-legend' class="d-inline-block">
                <div>Upcoming Overlay Bikeways (FY2023)</div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #19c615;"></div>
                    Protected Bikeway (Class IV)
                </div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #f0bd09;"></div>
                    Unprotected Bike Lane (Class II)
                </div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #f65b5b;"></div>
                    Sharrow (Class III)
                </div>
            </div>
            <div id='slurry-legend' class="d-inline-block">
                <div>Upcoming Slurry Bikeways (FY2023)</div>
                <!-- <div class="ms-2">
                    <div class="dot" style="background-color: #19c615;"></div>
                    Protected Bikeway (Class IV)
                </div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #f0bd09;"></div>
                    Unprotected Bike Lane (Class II)
                </div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #f65b5b;"></div>
                    Sharrow (Class III)
                </div> -->
            </div>
            <div id='sandag-legend' class="d-inline-block">
                <div>Upcoming SANDAG Bikeways</div>
                <!-- <div class="ms-2">
                    <div class="dot" style="background-color: #19c615;"></div>
                    Protected Bikeway (Class IV and I)
                </div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #f0bd09;"></div>
                    Unprotected Bike Lane (Class II and V)
                </div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #f65b5b;"></div>
                    Sharrow (Class III)
                </div> -->
            </div>
            <div id='existing-legend' class="d-inline-block">
                <div>Existing Bikeways</div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #c2e0c1;"></div>
                    Protected Bikeway (Class IV and I)
                </div>
                <div class="ms-2">
                    <div class="dot" style="background-color: #e9d9a9;"></div>
                    Unprotected Bike Lane (Class II and V)
                </div>
            </div>
            <div id='paving-legend' class="d-inline-block">
                <div>
                    <div class="dot" style="background-color: gray;"></div>
                    All Upcoming Paving Projects
                </div>
            </div>
            <div id='sexy-legend' class="d-inline-block">
                <div>
                    <div class="dot" style="background-color: DeepPink;"></div>
                    Todd Gloria's ✨Sexy✨ Streets Projects
                </div>
            </div>
        </div>

        <script>
            function fetchJSON(url) {
                return fetch(url)
                    .then(function(response) {
                        return response.json();
                    });
            }

            function resetLayerOrder() {
                Object.values(layers).forEach(l => l.bringToBack())
            }

            var map = L.map('map', {
                preferCanvas: true
            }).setView([32.7157, -117.1611], 12);
            var myRenderer = L.canvas({ padding: 0.5 });


            const base = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            
            let pavings = L.geoJSON([], { style: {color: 'gray', weight: 1} });
            let sexyStreets = L.geoJSON([], { style: {color: 'DeepPink', weight: 1} });
            let existingBikeways = L.geoJSON([], { 
                style: function(feature) {
                    switch (feature.properties["ROUTE"]) {
                        case 1: 
                        case 4: return { color: "#c2e0c1", weight: 3 };
                        case 5: 
                        case 2: return { color: "#e9d9a9", weight: 2 };
                        case 3: return { color: "#f9bebe", weight: 1 };
                    }
                },
                filter: function(feature, layer) {
                    return feature.properties["ROUTE"] !== 3;
                }
                }
            );
            let slurryBikeways = L.geoJSON([], 
                { 
                    style: function(feature) {
                        switch (feature.properties.bike_class) {
                            case 'IV':  return { color: "#19c615", weight: 6, dashArray: "4, 4", lineCap: 'butt' };
                            case 'II':  return { color: "#f0bd09", weight: 4, dashArray: "4, 4", lineCap: 'butt' };
                            case 'III': return { color: "#f65b5b", weight: 1.5, dashArray: "4, 4", lineCap: 'butt' };
                        }
                    } 
                }
            ).addTo(map);
            let overlayBikeways = L.geoJSON([], 
                { 
                    style: function(feature) {
                        switch (feature.properties.bike_class) {
                            case 'IV':  return { color: "#19c615", weight: 6, dashArray: "4, 4", lineCap: 'butt' };
                            case 'II':  return { color: "#f0bd09", weight: 4, dashArray: "4, 4", lineCap: 'butt' };
                            case 'III': return { color: "#f65b5b", weight: 1.5, dashArray: "4, 4", lineCap: 'butt' };
                        }
                    } 
                }
            ).addTo(map);

            let sandagUpcoming = L.esri.featureLayer({
                url: 'https://services1.arcgis.com/HG80xaIVT1z1OdO5/ArcGIS/rest/services/Bikeways_Coming_Soon/FeatureServer/2',
                style: (feature) => {
                    switch (feature.properties["ROUTE"]) {
                        case 1: 
                        case 4: return { color: "#19c615", weight: 5, dashArray: "4, 4", lineCap: 'butt' };
                        case 5: 
                        case 2: return { color: "#f0bd09", weight: 4, dashArray: "4, 4", lineCap: 'butt' };
                        case 3: return { color: "#f65b5b", weight: 1.5, dashArray: "4, 4", lineCap: 'butt' };
                    }
                }
            });
            sandagUpcoming.bindPopup((feature) => {
                const tooltip = Object.entries(feature.feature.properties).map(([key, value]) => 
                `<div><b>${key}</b>: ${value}</div>`
                ).join(' ');
                return tooltip;
            });


            const layers = {
                [document.getElementById('overlay-legend').outerHTML]: overlayBikeways,
                [document.getElementById('slurry-legend').outerHTML]: slurryBikeways,
                [document.getElementById('sandag-legend').outerHTML]: sandagUpcoming,
                [document.getElementById('existing-legend').outerHTML]: existingBikeways,
                [document.getElementById('paving-legend').outerHTML]: pavings,
                [document.getElementById('sexy-legend').outerHTML]: sexyStreets,
            };
            let layerControl = L.control.layers({}, layers, { collapsed: true }).addTo(map);
            layerControl.expand();

            const overlayReq = fetchJSON('/FY2023_overlay_bikeways.geojson')
            overlayReq.then((r) => {
                overlayBikeways.addData(r['features']);
                overlayBikeways.bindPopup((feature) => {
                    const tooltip = Object.entries(feature.feature.properties).map(([key, value]) => 
                    `<div><b>${key}</b>: ${value}</div>`
                    ).concat('<div><b>Type</b>: Overlay</div>').join(' ');
                    return tooltip;
                });
                resetLayerOrder();
            })

            const slurryReq = fetchJSON('/FY2023_slurry_bikeways.geojson')
            slurryReq.then((r) => {
                slurryBikeways.addData(r['features']);
                slurryBikeways.bindPopup((feature) => {
                    const tooltip = Object.entries(feature.feature.properties).map(([key, value]) => 
                    `<div><b>${key}</b>: ${value}</div>`
                    ).concat('<div><b>Type</b>: Slurry</div>').join(' ');
                    return tooltip;
                });
                resetLayerOrder();
            })

            const pavingReq = fetchJSON('/planned_paving.geojson')
            pavingReq.then((r) => {
                pavings.addData(r['features'])
                pavings.bindPopup((feature) => {
                    const tooltip = Object.entries(feature.feature.properties).map(([key, value]) => 
                        `<div><b>${key}</b>: ${value}</div>`
                    ).join(' ');
                    return tooltip;
                });
                resetLayerOrder();
            })

            const sexyStreetsReq = fetchJSON('/sexy_streets_merged.geojson')
            sexyStreetsReq.then((r) => {
                sexyStreets.addData(r['features'])
                sexyStreets.bindPopup((feature) => {
                    const tooltip = Object.entries(feature.feature.properties).map(([key, value]) => 
                        `<div><b>${key}</b>: ${value}</div>`
                    ).join(' ');
                    return tooltip;
                });
                resetLayerOrder();
            })

            const bikewaysReq = fetchJSON('/bikeways_merged.geojson')
            bikewaysReq.then((r) => {
                existingBikeways.addData(r['features'])
                existingBikeways.bindPopup((feature) => {
                    const tooltip = Object.entries(feature.feature.properties).map(([key, value]) => 
                        `<div><b>${key}</b>: ${value}</div>`
                    ).join(' ');
                    return tooltip;
                });
                resetLayerOrder();
            })

            map.on('overlayadd', resetLayerOrder);
        </script>
    </body>
</html>